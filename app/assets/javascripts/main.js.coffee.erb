window.WAH ||= {}
WAH.controllers ||= {}

Simmr.factory "Follow", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/follows"
    name: "follow"
]

Simmr.factory "Event", ["railsResourceFactory", (railsResourceFactory) -> railsResourceFactory
    url: "/api/events"
    name: "event"
]

Simmr.factory "Charge", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/charges"
    name: "charge"
]

Simmr.factory "User", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/user"
    name: "user"
]

Simmr.factory "Guest", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/guests"
    name: "guest"
]

Simmr.directive "heart", ->
  {
  restrict: 'E'
  scope:
    followableType: "="
    followableId: "="
    userId: "="
  templateUrl: "<%= asset_path('templates/heart.html') %>"
  }

Simmr.controller "HeartCtrl", ["$scope","$http",  "$routeParams", "Follow", ($scope,$http, $routeParams, Follow) ->
  $scope.join = false

  $scope.addFollower = (followable_type_val, followable_id_val, user_signed_in, number_followers) ->
    if user_signed_in
      console.log "Follow Information:*******"
      console.log followable_type_val
      console.log followable_id_val
      console.log number_followers
      console.log $(this)
      console.log $scope.this
      $scope.follows = number_followers
      $http({method:'GET',url:'/api/follows',params:{followable_id:followable_id_val,followable_type:followable_type_val}}).success (result) ->
        #Follow.get(params:[followable_id:followable_id_val,followable_type:followable_type_val]).then (result) ->
        if result.length > 0
          $scope.confirm = confirm("Are you sure you want to unfollow?")
          if ($scope.confirm == true) 
            $scope.following = false;
            $scope.join = false;
            $http({method:'DELETE',url:"/api/follows/#{result[0].id}"}).success (result) ->
              #destroy follow with confirmation
              console.log "Destroyed Follow"
              $scope.follows--
            
        else
          $scope.following = true;
          $http({method:'POST',url:'/api/follows',params:{followable_id:followable_id_val,followable_type:followable_type_val}}).success (result) ->
            $scope.join = true;
            console.log "Created Follow"
            $scope.follows++


  $scope.follow = (followable_type_val, followable_id_val, user_signed_in)->
    if user_signed_in
      console.log "Follow Information:*******"
      console.log followable_type_val
      console.log followable_id_val
      $http({method:'GET',url:'/api/follows',params:{followable_id:followable_id_val,followable_type:followable_type_val}}).success (result) ->
        #Follow.get(params:[followable_id:followable_id_val,followable_type:followable_type_val]).then (result) ->
        if result.length > 0
          $scope.confirm = confirm("Are you sure you want to unfollow?")
          if ($scope.confirm == true) 
            $scope.following = false;
            $http({method:'DELETE',url:"/api/follows/#{result[0].id}"}).success (result) ->
              #destroy follow with confirmation
              $scope.join = false
              console.log "Destroyed Follow"
            
        else
          $scope.following = true;
          $http({method:'POST',url:'/api/follows',params:{followable_id:followable_id_val,followable_type:followable_type_val}}).success (result) ->
            $scope.join = true
            console.log "Created Follow"  

]

Simmr.controller "HeaderCtrl", ["$scope",  "$routeParams", ($scope, $routeParams) ->
  $scope.search = (searchQuery) ->
    window.location= "/events?q=#{searchQuery}"
  $scope.keypressCallback = ($event) ->
    $scope.search($scope.searchQuery)
    $event.preventDefault()
]

Simmr.controller "HomeIndexCtrl", ["$scope",  "$routeParams", "$location", ($scope, $routeParams, $location) ->
  Simmr.scopes ||= {}  
  Simmr.scopes.home = $scope
  $scope.appear = ''
  if location.search == '?foodie=true'
    $(".foodiesignup").click()
  if location.search == '?foodie=false'
    $(".bizsignup").click()
]

Simmr.controller "EventRegisterCtrl", ["$scope",  "$routeParams", "$location", "Charge", "Event", "Guest", ($scope, $routeParams, $location, Charge, Event, Guest) ->
  Simmr.scopes ||= {}  
  Simmr.scopes.event = $scope

  if location.search == '?grabSeats'
    $scope.showSeats = true

  if location.search == '?waitList'
    $scope.waitlist = true

  $scope.guests = []
  $scope.event = []

  $scope.guest = {}
  $scope.guest.first_name = ''
  $scope.guest.last_name = ''
  $scope.guest.email = ''
  $scope.buyer = {}

  $scope.expirationMonths = [
    '01',
    '02',
    '03',
    '04',
    '05',
    '06',
    '07',
    '08',
    '09',
    '10',
    '11',
    '12' ]

  $scope.expirationYears = [
    '2013',
    '2014',
    '2015',
    '2016',
    '2017',
    '2018',
    '2019',
    '2020',
    '2021',
    '2022',
    '2023',
    '2024' ]

  $scope.eventDate = ->
    moment($scope.event.date).format("dddd, MMMM D")

  $scope.eventTime = ->
    moment($scope.event.time, "YYYY-MM-DD H:mm:ss").format("h:mm A")
  
  $scope.eventEndTime = ->
    datetime = moment($scope.event.time,  "YYYY-MM-DD H:mm:ss")
    datetime.add('minutes', $scope.event.length).format('h:mm A')

  $scope.mapUrl = ->
    mapUrl = "http://maps.google.com/?q=#{$scope.address1},#{$scope.city}, #{$scope.state},#{$scope.zipcode}"

  $scope.total = ->
    total = $scope.num_guests * $scope.cost
    total = total.toFixed(2)

  $scope.eventRevenue = ->
    total = $scope.guestsCount * $scope.cost
    total = total.toFixed(0)

  $scope.showPayment = (wait) ->
    $scope.guests = []
    $scope.guest_no_pages = 0
    if $scope.num_guests > 0
      homie=$scope.currentUser
      currentGuy={}
      currentGuy.first_name=homie.first_name
      currentGuy.last_name=homie.last_name
      currentGuy.email=homie.email
      currentGuy.userId=homie.id
      currentGuy.eventId=$scope.eventId
      currentGuy.waiting=true
      $scope.guests.push(currentGuy)
      i = 0
      
      while i < $scope.num_guests - 1
        $scope.guests.push({})
        i++
    if wait
      $scope.appear = "waitlist1"
    else
      $scope.appear = "payment1"

  $scope.addtoWaitlist = ->
    angular.forEach($scope.guests, (guest) =>
      guest.eventId=$scope.eventId
      guest.waiting=true
      new Guest(guest).create().then (data) =>
        console.log data, "~~~~~~~~~~~"
    )
    $scope.appear = "waitlist2"

  $scope.gotoPayment = ->
    error = 0
    angular.forEach($scope.guests, (guest) =>
      if typeof guest.first_name is 'undefined' || typeof guest.email is 'undefined' || guest.last_name is 'undefined'
        error = 1
    )
    if error == 0
      $scope.appear = "payment2"

  $scope.submitPayment = ->    
    $scope.submitCard($scope.card)

  $scope.card =
    number: ""
    expMonth: ""
    expYear: ""
    cvc: ""

  $scope.data = {}
  $scope.cardErrorMessages={}
  $scope.submitCard = (card) ->
    card.name=$scope.buyer.name
    Stripe.createToken card, (status, response) ->
      if status is 200
        console.log response
        $scope.data.last4 = response.card.last4
        $scope.data.token = response.id
        $scope.data.guests = $scope.guests
        $scope.data.buyer = $scope.buyer
        $scope.data.eventId = $scope.eventId
        $scope.data.amount = $scope.total()

        new Charge($scope.data).create().then (data) =>
          console.log data, "~~~~~~~~~~"
          if data.status == "Success"
            $scope.appear = "payment3"
          if data.status == "Failure"
            $scope.cardErrorMessages=data.messages
            $scope.card.expYear = $scope.card.exp_year
            $scope.card.expMonth = $scope.card.exp_month

      else
        console.log response
]

Simmr.controller "EventCreateCtrl", ["$scope",  "$routeParams", "$location", "Event", ($scope, $routeParams, $location, Event) ->
  $scope.created = false
  $scope.eventImageUrls = []
  $scope.eventMenu = []
  $scope.today = moment().format("YYYY-MM-DD")

  $scope.eventDate = ->
    moment($scope.event.date).format("dddd, MMMM D")

  $scope.eventTime = ->
    moment($scope.event.time, "YYYY-MM-DD H:mm:ss").format("h:mm A")
  
  $scope.eventEndTime = ->
    datetime = moment($scope.event.time,  "YYYY-MM-DD H:mm:ss")
    datetime.add('minutes', $scope.event.length).format('h:mm A')

  $scope.uploadImages = ->
    filepicker.pickAndStore
      mimetypes: ["image/*", "text/plain"]
      services: ["COMPUTER", "FACEBOOK", "GMAIL", "INSTAGRAM"]
      multiple: true
    ,
      location: "S3"
      access: "public"
    , (InkBlobs) ->
      console.log JSON.stringify(InkBlobs)

      $('.default').remove()
      $('.carousel-inner').empty()
      $scope.eventImageUrls = []

      i=0
      while i< Object.keys(InkBlobs).length
        $scope.image="#{InkBlobs[i].url}"
        console.log $scope.image
        $scope.eventImageUrls.push($scope.image)
        if i == 0
          console.log($scope.eventImageUrls[i])
          $('.events .carousel-inner').append("<div class = 'item active'><img src = #{$scope.eventImageUrls[i]}></div>")
        else 
          console.log('else')
          $('.events .carousel-inner').append("<div class = 'item'><img src = #{$scope.eventImageUrls[i]}></div>")
        i++
      $('#remove-image').css('display', 'inherit')
      if Object.keys(InkBlobs).length>1
        $('.event-profile').append("<a class = 'carousel-control left hidden-phone' data-slide = 'prev' href = '#event-carousel'> ‹ </a><a class = 'carousel-control right hidden-phone' data-slide = 'next' href = '#event-carousel'> › </a>")


  $scope.removeImages = ->
    currentImage = $(".active img").attr('src')
    $('.item.active').remove()
    $('.item:first-child').addClass('active')
    i = 0
    while i < $scope.eventImageUrls.length
      if currentImage == $scope.eventImageUrls[i]
        $scope.eventImageUrls.splice(i, 1)
      i++
    if $scope.eventImageUrls.length <= 1
      $('.carousel-control').remove()
    if $scope.eventImageUrls.length == 0
        $('#remove-image').css('display', 'none')
        $('.events .carousel-inner').append("<p>This is a default cover photo. <br> Replace by uploading cover images!</p><div class = 'item active default'><img alt='Food 26' src='/assets/Food 26.jpg'></div>")

  $scope.uploadMenu = ->
    filepicker.pickAndStore
      extension: '.pdf'
      services: ["COMPUTER", "GMAIL"]
      multiple: false
    ,
      location: "S3"
      access: "public"
    , (InkBlob) ->
      console.log JSON.stringify(InkBlob)
      $scope.menuPdf="#{InkBlob[0].url}"
      console.log $scope.menuPdf
      $('.events .menu').append("<a href =#{$scope.menuPdf}> Menu.pdf </a>")
      $('a#remove').css('display', 'inline')


  $scope.removeMenu = ->
    $scope.menuPdf = []
    $('.menu').empty()
    $('a#remove').css('display', 'none')

  $scope.createEvent = (event) ->
    console.log($scope.eventImageUrls)
    console.log($scope.menuPdf)
    if $scope.eventImageUrls?
      event.eventImageUrls=$scope.eventImageUrls
    if $scope.menuPdf?
      event.menuPdf=$scope.menuPdf
    new Event(event).create().then (data) =>
      console.log data, "~~~~~~~~~~"
      $scope.created = true
      window.location.href = '/events/'+data.id
]

Simmr.controller "EventIndexCtrl", ["$scope",  "$routeParams", "$location", "Event", ($scope, $routeParams, $location, Event) ->
]

Simmr.controller "EventEditCtrl", ["$scope",  "$routeParams", "$location", "Event", ($scope, $routeParams, $location, Event) ->
  $scope.eventImageUrls = []


  $scope.getEvent = (eventId) ->
    console.log Event
    Event.get(id: eventId).then (result) ->
      $scope.event = result
      console.log $scope.event, "++++++"

  $scope.today = moment().format("YYYY-MM-DD")
  $scope.imageUrls = []

  $scope.eventDate = ->
    moment($scope.event.date).format("dddd, MMMM D")

  $scope.eventTime = ->
    moment($scope.event.time, "YYYY-MM-DD H:mm:ss").format("h:mm A")
  
  $scope.eventEndTime = ->
    datetime = moment($scope.event.time,  "YYYY-MM-DD H:mm:ss")
    datetime.add('minutes', $scope.event.length).format('h:mm A')

  $scope.uploadMenu = ->
    console.log($scope.eventMenu)
    filepicker.pickAndStore
      extension: '.pdf'
      services: ["COMPUTER", "GMAIL"]
      multiple: false
    ,
      location: "S3"
      access: "public"
    , (InkBlob) ->
      console.log JSON.stringify(InkBlob)
      $scope.menuPdf="#{InkBlob[0].url}"
      console.log $scope.menuPdf
      $('.events .menu').append("<a href =#{$scope.menuPdf}> Menu.pdf </a>")
      $('a#remove').css('display', 'inline')

  $scope.removeMenu = ->
    $scope.menuPdf = []
    $('.menu').empty()
    $('a#remove').css('display', 'none')

  $scope.uploadImages = ->
    #need to check if existing images are there to decide whether or not need an active class
    console.log $scope.eventImages
    filepicker.pickAndStore
      mimetypes: ["image/*", "text/plain"]
      services: ["COMPUTER", "FACEBOOK", "GMAIL", "INSTAGRAM"]
      multiple: true
    ,
      location: "S3"
      access: "public"
    , (InkBlobs) ->
      console.log JSON.stringify(InkBlobs)

      $('.default').remove()
      $('.carousel-inner').empty()
      $scope.eventImageUrls = []

      i=0
      while i< Object.keys(InkBlobs).length
        $scope.image="#{InkBlobs[i].url}"
        console.log $scope.image
        $scope.eventImageUrls.push($scope.image)
        if i == 0
          console.log($scope.eventImageUrls[i])
          $('.events .carousel-inner').append("<div class = 'item active'><img src = #{$scope.eventImageUrls[i]}></div>")
        else 
          console.log('else')
          $('.events .carousel-inner').append("<div class = 'item'><img src = #{$scope.eventImageUrls[i]}></div>")
        i++
      $('#remove-image').css('display', 'inherit')
      if Object.keys(InkBlobs).length>1
        $('.event-profile').append("<a class = 'carousel-control left hidden-phone' data-slide = 'prev' href = '#event-carousel'> ‹ </a><a class = 'carousel-control right hidden-phone' data-slide = 'next' href = '#event-carousel'> › </a>")

  $scope.removeImages = ->
    currentImage = $(".active img").attr('src')
    $('.item.active').remove()
    $('.item:first-child').addClass('active')
    i = 0
    while i < $scope.eventImageUrls.length
      if currentImage == $scope.eventImageUrls[i]
        $scope.eventImageUrls.splice(i, 1)
      i++
    if $scope.eventImageUrls.length <= 1
      $('.carousel-control').remove()
    if $scope.eventImageUrls.length == 0
        $('#remove-image').css('display', 'none')
        $('.events .carousel-inner').append("<p>This is a default cover photo. <br> Replace by uploading cover images!</p><div class = 'item active default'><img alt='Food 26' src='/assets/Food 26.jpg'></div>")

  $scope.editEvent = (event) ->
    event.eventImageUrls=$scope.eventImageUrls
    event.menuPdf=$scope.menuPdf
    new Event(event).update().then (data) =>
      window.a=data
      $scope.event=data
      window.location.href = '/events/'+data.id
]

Simmr.controller "EventFeedbackCtrl", ["$scope",  "$routeParams", "$location", "Event", "Guest", ($scope, $routeParams, $location, Event, Guest) ->
  Simmr.scopes ||= {}  
  Simmr.scopes.post_event = $scope

  if location.search == '?waitList'
    $scope.waitlist = true

  $scope.guest = {}
  $scope.guest.first_name = ''
  $scope.guest.last_name = ''
  $scope.guest.email = ''

  $scope.showPayment = (wait) ->
    $scope.guests = []
    if $scope.num_guests > 0
      homie=$scope.currentUser
      currentGuy={}
      currentGuy.first_name=homie.first_name
      currentGuy.last_name=homie.last_name
      currentGuy.email=homie.email
      currentGuy.userId=homie.id
      currentGuy.eventId=$scope.eventId
      currentGuy.waiting=true
      $scope.guests.push(currentGuy)
      i = 0
      
      while i < $scope.num_guests - 1
        $scope.guests.push({})
        i++
    if wait
      $scope.appear = "waitlist1"
    else
      $scope.appear = "payment1"
    
    console.log $scope.num_guests
    console.log $scope.guests

  $scope.addtoWaitlist = ->
    angular.forEach($scope.guests, (guest) =>
      guest.eventId=$scope.eventId
      guest.waiting=true
      new Guest(guest).create().then (data) =>
        console.log data, "~~~~~~~~~~~"
    )
    $scope.appear = "waitlist2"

  $scope.mapUrl = ->
    mapUrl = "http://maps.google.com/?q=#{$scope.address1},#{$scope.city}, #{$scope.state},#{$scope.zipcode}"

  $scope.eventDate = ->
    moment($scope.event.date).format("dddd, MMMM D")

  $scope.eventTime = ->
    moment($scope.event.time, "YYYY-MM-DD H:mm:ss").format("h:mm A")
  
  $scope.eventEndTime = ->
    datetime = moment($scope.event.time,  "YYYY-MM-DD H:mm:ss")
    datetime.add('minutes', $scope.event.length).format('h:mm A')

]

Simmr.factory "Campaign", ["railsResourceFactory", (railsResourceFactory) ->
  railsResourceFactory
    url: "/api/campaigns"
    name: "campaign"
]

Simmr.controller "CampaignJoinCtrl", ["$scope", "$window", "$routeParams", "$location", "Campaign", ($scope, $window, $routeParams, $location, Campaign) ->

]

Simmr.controller "CampaignIndexCtrl", ["$scope", "$window", "$routeParams", "$location", "Campaign", ($scope, $window, $routeParams, $location, Campaign) ->

]

Simmr.controller "CampaignCreateCtrl", ["$scope", "$window", "$routeParams", "$location", "Campaign", ($scope, $window, $routeParams, $location, Campaign) ->

  $scope.campaignImageUrls = []

  $scope.uploadImages = ->
    filepicker.pickAndStore
      mimetypes: ["image/*", "text/plain"]
      services: ["COMPUTER", "FACEBOOK", "GMAIL", "INSTAGRAM"]
      multiple: true
    ,
      location: "S3"
      access: "public"
    , (InkBlobs) ->
      console.log JSON.stringify(InkBlobs)

      $('.default').remove()
      $('.carousel-inner').empty()
      $scope.campaignImageUrls = []

      i=0
      while i< Object.keys(InkBlobs).length
        $scope.image="#{InkBlobs[i].url}"
        console.log $scope.image
        $scope.campaignImageUrls.push($scope.image)
        if i == 0
          $('.campaigns .carousel-inner').append("<div class = 'item active'><img src = #{$scope.campaignImageUrls[i]}></div>")
        else 
          $('.campaigns .carousel-inner').append("<div class = 'item'><img src = #{$scope.campaignImageUrls[i]}></div>")
        i++
      $('#remove-image').css('display', 'inherit')
      if Object.keys(InkBlobs).length>1
        $('.campaign-profile').append("<a class = 'carousel-control left hidden-phone' data-slide = 'prev' href = '#campaign-carousel'> ‹ </a><a class = 'carousel-control right hidden-phone' data-slide = 'next' href = '#campaign-carousel'> › </a>")

  $scope.removeImages = ->
    currentImage = $(".active img").attr('src')
    $('.item').remove(":contains('#{currentImage}')")
    $('.carousel-inner div:first-child').append('.active')
    i = 0
    while i < $scope.campaignImageUrls.length
      if currentImage == $scope.campaignImageUrls[i]
        $scope.campaignImageUrls.splice(i, 1)
      i++
    if $scope.campaignImageUrls.length <= 1
      $('.carousel-control').remove()

  $scope.createCampaign = (campaign) ->
    if $scope.campaignImageUrls?
      campaign.campaignImageUrls=$scope.campaignImageUrls
    new Campaign(campaign).create().then (data) =>
      console.log data, "~~~~~~~~~~"
      $scope.campaign = 1
      $window.location.href='/campaigns/'
]

Simmr.controller "CampaignEditCtrl", ["$scope",  "$routeParams", "$location", "Campaign", ($scope, $routeParams, $location, Campaign) ->
  $scope.getCampaign = (campaignId) ->
    console.log campaignId
    Campaign.get(id: campaignId).then (result) ->
      console.log result, "++++++++"
      $scope.campaign = result
  $scope.editCampaign = (campaign) ->
    new Campaign(campaign).update().then (data) =>
      window.a=data
      $scope.campaign=data
      window.location.href = '/campaigns/'+data.id

  $scope.campaignImageUrls = []

  $scope.uploadImages = ->
    filepicker.pickAndStore
      mimetypes: ["image/*", "text/plain"]
      services: ["COMPUTER", "FACEBOOK", "GMAIL", "INSTAGRAM"]
      multiple: true
    ,
      location: "S3"
      access: "public"
    , (InkBlobs) ->
      console.log JSON.stringify(InkBlobs)

      $('.default').remove()
      $('.carousel-inner').empty()
      $scope.campaignImageUrls = []

      i=0
      while i< Object.keys(InkBlobs).length
        $scope.image="#{InkBlobs[i].url}"
        console.log $scope.image
        $scope.campaignImageUrls.push($scope.image)
        if i == 0
          $('.campaigns .carousel-inner').append("<div class = 'item active'><img src = #{$scope.campaignImageUrls[i]}></div>")
        else 
          $('.campaigns .carousel-inner').append("<div class = 'item'><img src = #{$scope.campaignImageUrls[i]}></div>")
        i++
      $('#remove-image').css('display', 'inherit')
      if Object.keys(InkBlobs).length>1
        $('.campaign-profile').append("<a class = 'carousel-control left hidden-phone' data-slide = 'prev' href = '#campaign-carousel'> ‹ </a><a class = 'carousel-control right hidden-phone' data-slide = 'next' href = '#campaign-carousel'> › </a>")


  $scope.removeImages = ->
    currentImage = $(".active img").attr('src')
    $('.item').remove(":contains('#{currentImage}')")
    $('.carousel-inner div:first-child').append('.active')
    i = 0
    while i < $scope.campaignImageUrls.length
      if currentImage == $scope.campaignImageUrls[i]
        $scope.campaignImageUrls.splice(i, 1)
      i++
    if $scope.campaignImageUrls.length <= 1
      $('.carousel-control').remove()
]

